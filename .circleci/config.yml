version: 2.1

orbs:  
  python: circleci/python@1.0.0

jobs:  
  build-and-test:    
    executor:
      name: python/default
      tag: '3.7'
    steps:
      - checkout
      - run:
          name: Log in to docker hub
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PAS
      - run:
          name: Build from dockerfile
          command: |
            docker build -t $IMAGE_NAME:$IMAGE_TAG .
      - run:
          name: Tag stuff
          command: docker tag $IMAGE_TAG $DOCKER_USER/$IMAGE_TAG
      - run:
          name: Push image ig
          command: docker push $IMAGE_NAME:$IMAGE_TAG

      # - run:
      #     name: Install Dependencies
      #     command: pip install -r requirements.txt
      # - run:
      #     name: Run file
      #     command: uvicorn app:app --reload
    
workflows:  
  build-test-and-deploy:    
    jobs:      
      - build-and-test:
          filters:            
            branches:
              only:
                - main